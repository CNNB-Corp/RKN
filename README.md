# RKN

`RKN.ps1` — минимальный PowerShell-скрипт с меню, который:

- сам подбирает рабочую DNS-инфраструктуру из списка кандидатов;
- применяет настройки для активных сетевых адаптеров;
- проверяет доступность через HTTP, ping и TCP-тесты;
- умеет быстро включать/выключать и показывать статус;
- поддерживает базовые и гибкие настройки.

## Быстрый старт

1. Откройте PowerShell от имени администратора.
2. Перейдите в каталог проекта.
3. Разрешите выполнение локальных скриптов (однократно на текущую сессию):

```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
```

4. Запустите скрипт:

```powershell
./RKN.ps1
```

## Запуск через .exe

Если хотите запускать RKN через файл `RKN.exe`, используйте готовый лаунчер:

1. Перейдите в папку `launcher`.
2. Соберите `RKN.exe`:

```cmd
build.cmd
```

> Скрипт сборки рассчитан на стандартный `csc.exe` из .NET Framework (C# 5), поэтому лаунчер написан без интерполяции строк.

3. Скопируйте `RKN.exe` в корень проекта рядом с `RKN.ps1`.
4. Запускайте `RKN.exe` (скрипт будет стартовать автоматически).

## Возможные проблемы

### Ошибка парсинга с «Непредвиденная лексема»

Если PowerShell ругается на неожиданные токены, убедитесь, что файл сохранен в UTF-8 с BOM (подписью). 
В репозитории файл уже записан в UTF-8 BOM. Если вы пересохранили его через редактор, верните кодировку.

Также можно запускать так:

```powershell
powershell.exe -NoProfile -ExecutionPolicy Bypass -File .\\RKN.ps1
```

## Настройки

- Базовые настройки доступны из меню.
- Гибкие настройки открывают `config/rkn.settings.json` в блокноте.
- В `Advanced.RequiredHttpTestUrls` указываются обязательные HTTP-проверки (например, YouTube/Discord). Если хотя бы одна из них не проходит, кандидат отклоняется.
- В `Advanced.OptionalHttpTestUrls` можно указать дополнительные URL (например, Microsoft/Apple/OpenAI — msftconnecttest, apple robots), которые дополняют проверку.
- Параметр `Advanced.HttpRequireAll` определяет логику проверки дополнительных тестов: `false` — достаточно успеха хотя бы по одному из включенных тестов, `true` — все типы проверок должны пройти.
- `Advanced.PingTargets` задаёт хосты/IP для ping-проверки.
- `Advanced.TcpTestTargets` задаёт TCP-проверки (host/port), чтобы подтвердить доступность сервисов (по умолчанию — только YouTube/Discord).

> Примечание: Apple/Microsoft/OpenAI не публикуют отдельные публичные DNS-резолверы. Если у вас есть конкретные IP их корпоративных DNS, добавьте их в `Advanced.DnsCandidates`.

> Скрипт сохраняет предыдущие DNS-настройки в `config/rkn.state.json`, чтобы корректно восстановить их при остановке.
